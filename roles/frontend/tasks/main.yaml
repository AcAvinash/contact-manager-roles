---
#  Create swap file (optional for low-memory EC2)
- name: Create swap file (2 GB)
  ansible.builtin.shell: |
    dd if=/dev/zero of=/swapfile bs=1M count=2048
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
  args:
    creates: /swapfile

#  Create application user
- name: Create application user
  ansible.builtin.import_role:
    name: common
    tasks_from: user-setup

#  Setup application directory
- name: Setup application directory
  ansible.builtin.import_role:
    name: common
    tasks_from: app-setup



#  Install NodeJS
- name: Install NodeJS
  ansible.builtin.import_role:
    name: common
    tasks_from: nodejs

#  Remove old node_modules if any
- name: Remove old node_modules
  file:
    path: "{{ app_dir }}/node_modules"
    state: absent
  become_user: "{{ app_user }}"

#  Clean npm cache
- name: Clean npm cache
  command: npm cache clean --force
  become_user: "{{ app_user }}"

#  Install git
- name: Install git
  ansible.builtin.package:
    name: git
    state: present

#  Clone frontend repo
- name: Clone frontend repo to temp directory
  git:
    repo: "{{ frontend_repo_url }}"
    dest: "/tmp/contact-manager"
    version: "{{ frontend_branch }}"
    force: yes

#  Ensure /app exists
- name: Ensure /app exists
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"

# Fix permissions of temp repo for roboshop
- name: Fix permissions of temp repo
  file:
    path: /tmp/Contact-Manager
    state: directory
    recurse: yes
    owner: "{{ app_user }}"
    group: "{{ app_user }}"

# Move client folder from temp to /app
- name: Move client folder to /app
  command: rsync -a /tmp/Contact-Manager/Frontend/ "{{ app_dir }}"
  become_user: "{{ app_user }}"

# Remove temp folder
- name: Remove temp repo folder
  file:
    path: /tmp/Contact-Manager
    state: absent

# Set frontend_workdir
- name: Set frontend working directory
  set_fact:
    frontend_workdir: "{{ app_dir }}"

#  Install frontend dependencies
- name: Install frontend dependencies
  npm:
    path: "{{ frontend_workdir }}"
    state: present
  become_user: "{{ app_user }}"

#  Build React App
- name: Build React App
  command: npm run build
  args:
    chdir: "{{ frontend_workdir }}"
  become_user: "{{ app_user }}"

- name: Clean yum cache
  ansible.builtin.yum:
    name: "*"
    state: latest
    update_cache: yes

# Install Nginx
- name: Install Nginx
  ansible.builtin.yum:
    name: nginx
    state: present


- name: Ensure Nginx is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes

- name: Disable default nginx site
  file:
    path: /usr/share/nginx/html/index.html
    state: absent

# Configure Nginx for frontend
- name: Configure Nginx for Frontend
  template:
    src: frontend.j2
    dest: /etc/nginx/conf.d/frontend.conf
    mode: '0644'
  notify: Restart Nginx

- name: Ensure Nginx is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes


