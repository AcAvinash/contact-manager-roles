---
# Create swap file (optional for low-memory EC2)
- name: Create swap file (2 GB)
  ansible.builtin.shell: |
    dd if=/dev/zero of=/swapfile bs=1M count=2048
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
  args:
    creates: /swapfile

# Create application user
- name: Create application user
  ansible.builtin.import_role:
    name: common
    tasks_from: user-setup

# Setup application directory
- name: Setup application directory
  ansible.builtin.import_role:
    name: common
    tasks_from: app-setup

# Install NodeJS
- name: Install NodeJS
  ansible.builtin.import_role:
    name: common
    tasks_from: nodejs

# Remove old node_modules if any
- name: Remove old node_modules
  file:
    path: "{{ app_dir }}/node_modules"
    state: absent
  become_user: "{{ app_user }}"

# Clean npm cache
- name: Clean npm cache
  command: npm cache clean --force
  become_user: "{{ app_user }}"

# Install git
- name: Install git
  ansible.builtin.package:
    name: git
    state: present

# Clone frontend repo
- name: Clone frontend repo to temp directory
  git:
    repo: "{{ frontend_repo_url }}"
    dest: "/tmp/contact-manager"
    version: "{{ frontend_branch }}"
    force: yes

# Ensure /app exists
- name: Ensure /app exists
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"

# Fix permissions of temp repo for roboshop
- name: Fix permissions of temp repo
  file:
    path: /tmp/contact-manager
    state: directory
    recurse: yes
    owner: "{{ app_user }}"
    group: "{{ app_user }}"

# Move client folder from temp to /app
- name: Move client folder to /app
  command: rsync -a /tmp/contact-manager/client/ "{{ app_dir }}"
  become_user: "{{ app_user }}"

# Remove temp folder
- name: Remove temp repo folder
  file:
    path: /tmp/contact-manager
    state: absent

# Set frontend_workdir
- name: Set frontend working directory
  set_fact:
    frontend_workdir: "{{ app_dir }}"

# Install frontend dependencies
- name: Install frontend dependencies
  npm:
    path: "{{ frontend_workdir }}"
    state: present
  become_user: "{{ app_user }}"

# Build React App
- name: Build React App
  command: npm run build
  args:
    chdir: "{{ frontend_workdir }}"
  become_user: "{{ app_user }}"

# --- NGINX INSTALLATION SECTION ---
- name: Install Nginx
  block:
    - name: Update package cache
      ansible.builtin.yum:
        update_cache: yes
    
    - name: Check if amazon-linux-extras exists
      ansible.builtin.stat:
        path: /usr/bin/amazon-linux-extras
      register: al_extras
    
    - name: Install via amazon-linux-extras if available
      block:
        - name: Enable nginx repo
          ansible.builtin.shell: amazon-linux-extras enable nginx1 -y
          register: enable_result
          changed_when: "'already enabled' not in enable_result.stdout"
        
        - name: Install nginx
          ansible.builtin.yum:
            name: nginx
            state: present
            enablerepo: nginx1
      when: al_extras.stat.exists
    
    - name: Install directly if no amazon-linux-extras
      ansible.builtin.yum:
        name: nginx
        state: present
      when: not al_extras.stat.exists
  become: true

# Verify nginx installed
- name: Check if nginx installed
  ansible.builtin.shell: |
    which nginx || echo "nginx not found"
  register: nginx_check
  changed_when: false

- name: Debug nginx installation
  debug:
    msg: "Nginx check: {{ nginx_check.stdout }}"

# Ensure nginx directories exist
- name: Create nginx directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - /etc/nginx/conf.d
    - /var/log/nginx
    - /var/cache/nginx

# Remove default nginx config if exists
- name: Remove default nginx config
  file:
    path: /etc/nginx/conf.d/default.conf
    state: absent
  ignore_errors: yes

# Configure Nginx for frontend
- name: Configure Nginx for Frontend
  ansible.builtin.template:
    src: frontend.j2
    dest: /etc/nginx/conf.d/frontend.conf
    mode: '0644'
  notify: Restart Nginx

# Validate nginx configuration
- name: Validate nginx configuration
  ansible.builtin.shell: |
    nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0

# Ensure Nginx is running
- name: Ensure Nginx is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes

# Open firewall for HTTP/HTTPS (if firewall enabled)
- name: Open firewall ports for nginx
  ansible.builtin.firewalld:
    service: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  with_items:
    - http
    - https
  when: ansible_os_family == "RedHat" and ansible_service_mgr == "systemd"