- name: Create application user
  ansible.builtin.import_role:
    name: common
    tasks_from: user-setup

- name: Install NodeJS
  ansible.builtin.import_role:
    name: common
    tasks_from: nodejs

- name: Install PM2 globally
  npm:
    name: pm2
    global: yes
    state: present

- name: Setup application directory
  ansible.builtin.import_role:
    name: common
    tasks_from: app-setup

- name: Install git
  ansible.builtin.package:
    name: git
    state: present

- name: Remove old backend folder
  file:
    path: "{{ app_dir }}/{{ service_name }}/{{ backend_subpath }}"
    state: absent


- name: Clone backend repo to temp directory
  git:
    repo: "{{ backend_repo_url }}"
    dest: "/tmp/contact-manager"
    version: "{{ backend_branch }}"
    force: yes

- name: Ensure /app/backend exists
  file:
    path: "{{ app_dir }}"
    state: directory

- name: Move backend folder from temp to /app/backend
  command: mv /tmp/contact-manager/backend "{{ app_dir }}"

- name: Remove temp repo folder
  file:
    path: /tmp/contact-manager
    state: absent

- name: Set backend working directory
  set_fact:
    backend_workdir: "{{ app_dir }}"

- name: Debug backend path
  debug:
    msg: "{{ backend_workdir }}"

- name: Install backend dependencies
  npm:
    path: "{{ backend_workdir }}"
    state: present


- name: Start backend using PM2
  ansible.builtin.shell: |
    pm2 stop {{ service_name }} || true
    pm2 start {{ backend_workdir }}/server.js --name {{ service_name }}
    pm2 save

